name: Debian otel deb package generator

on: push

jobs:
  build-debs:
    strategy:
      matrix:
        build:
          - arch: amd64
            runs-on: buildjet-2vcpu-ubuntu-2204
          - arch: arm64
            runs-on: buildjet-2vcpu-ubuntu-2204-arm
    runs-on: ${{ matrix.build.runs-on }}
    steps:
      - uses: actions/checkout@v4
      - name: Restore helm and kubeform
        id: cached-deb-pkgs
        uses: actions/cache@v4
        with:
          path: |
            ~/debian/artifacts
          key: ${{ runner.os }}-debpackages
      - uses: jtdor/build-deb-action@v1
        id: builder
        if: steps.cached-binaries.output.cache-hit != 'true'
        name: build-deb
        env:
          DEB_BUILD_OPTIONS: noautodbgsym
        with:
          buildpackage-opts: -us -uc -b -rfakeroot
          extra-build-deps: ca-certificates
      - uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') && steps.cached-dep-pkgs.output.cache-hit != 'true'
        with:
          files: ${{ steps.builder.outputs.value }}
